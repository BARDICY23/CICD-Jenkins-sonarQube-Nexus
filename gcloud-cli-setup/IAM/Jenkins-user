#!/bin/bash
set -e

PROJECT_ID=$(gcloud config get-value project)
SA=jenkinscicd
SA_EMAIL=$SA@$PROJECT_ID.iam.gserviceaccount.com
KEY_PATH=~/temp/key.json

echo "⚙️  Creating new service account..."
gcloud iam service-accounts create $SA --display-name="Jenkins CI/CD Access"

echo "🔒 Granting roles..."
for ROLE in roles/artifactregistry.admin roles/run.admin; do
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SA_EMAIL" \
    --role="$ROLE"
done

echo "🗝️  Creating key..."
gcloud iam service-accounts keys create $KEY_PATH \
  --iam-account=$SA_EMAIL \
  --key-file-type=json

echo "✅ Done!"
echo "Service account: $SA_EMAIL"
echo "Key saved at: $KEY_PATH"

